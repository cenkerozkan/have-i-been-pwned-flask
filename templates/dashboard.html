{% extends "base.html" %}

{% block title %}Dashboard - Have I Been Pwned{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        margin: 20px;
    }
    .nav-tabs .nav-link.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    .tab-content {
        border: 1px solid #dee2e6;
        border-top: none;
        padding: 20px;
        min-height: 400px;
    }
    .email-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
    }
    .email-text {
        font-weight: 500;
    }
    .add-email-form {
        background-color: #f1f3f4;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .logout-btn {
        position: absolute;
        top: 20px;
        right: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header with Logout -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Have I Been Pwned - Dashboard</h1>
        <button type="button" class="btn btn-outline-danger logout-btn" onclick="logout()">
            Logout
        </button>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="emails-tab" data-bs-toggle="tab" data-bs-target="#emails" 
                    type="button" role="tab" aria-controls="emails" aria-selected="true">
                Emails
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="breaches-tab" data-bs-toggle="tab" data-bs-target="#breaches" 
                    type="button" role="tab" aria-controls="breaches" aria-selected="false">
                Breaches
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" 
                    type="button" role="tab" aria-controls="settings" aria-selected="false">
                Settings
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="dashboardTabsContent">
        <!-- Emails Tab -->
        <div class="tab-pane fade show active" id="emails" role="tabpanel" aria-labelledby="emails-tab">
            <h3>Email Management</h3>
            
            <!-- Add Email Form -->
            <div class="add-email-form">
                <h5>Add New Email</h5>
                <form id="addEmailForm">
                    <div class="input-group">
                        <input type="email" class="form-control" id="newEmailInput" 
                               placeholder="Enter email address" required>
                        <button type="submit" class="btn btn-primary">Add Email</button>
                    </div>
                </form>
            </div>

            <!-- Email List Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Your Monitored Emails</h5>
                <button type="button" class="btn btn-outline-danger btn-sm" id="deleteAllBtn" 
                        onclick="deleteAllEmails()" style="display: none;">
                    Delete All Emails
                </button>
            </div>

            <!-- Email List -->
            <div id="emailList">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Breaches Tab -->
        <div class="tab-pane fade" id="breaches" role="tabpanel" aria-labelledby="breaches-tab">
            <h3>Security Breaches</h3>
            <p>View breaches found for your monitored email addresses.</p>
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                This section will show any data breaches detected for your monitored email addresses.
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
            <h3>Scheduler Settings</h3>
            <p>Configure how frequently the system checks for new breaches.</p>
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                Configure monitoring frequency and notification preferences.
            </div>
        </div>
    </div>

    <!-- Alert for messages -->
    <div class="alert" role="alert" style="display: none; margin-top: 20px;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Check if user is authenticated
    const token = localStorage.getItem('jwt_token');
    if (!token) {
        // No token found, redirect to login
        window.location.href = '/api/user/login-page';
        return;
    }

    // Load emails when page loads and when emails tab is shown
    loadEmails();
    
    $('#emails-tab').on('shown.bs.tab', function() {
        loadEmails();
    });

    // Add email form submission
    $('#addEmailForm').on('submit', function(e) {
        e.preventDefault();
        addEmail();
    });

    function getAuthHeaders() {
        const token = localStorage.getItem('jwt_token');
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    }

    function loadEmails() {
        $.ajax({
            url: '/api/email',
            method: 'GET',
            headers: getAuthHeaders(),
            success: function(response) {
                if (response.success) {
                    displayEmails(response.data.emails);
                } else {
                    showAlert('danger', response.message);
                }
            },
            error: function(xhr) {
                if (xhr.status === 401) {
                    showAlert('danger', 'Session expired. Please login again.');
                    setTimeout(() => {
                        window.location.href = '/api/user/login-page';
                    }, 2000);
                } else {
                    showAlert('danger', 'Failed to load emails. Please try again.');
                }
            }
        });
    }

    function displayEmails(emails) {
        const emailList = $('#emailList');
        const deleteAllBtn = $('#deleteAllBtn');
        
        if (emails.length === 0) {
            emailList.html('<div class="alert alert-info">No emails added yet. Add your first email above!</div>');
            deleteAllBtn.hide();
            return;
        }

        // Show delete all button when there are emails
        deleteAllBtn.show();

        let emailsHtml = '';
        emails.forEach(email => {
            emailsHtml += `
                <div class="email-item" data-email-id="${email.id}">
                    <span class="email-text">${email.email}</span>
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteEmail(${email.id})">
                        Delete
                    </button>
                </div>
            `;
        });
        
        emailList.html(emailsHtml);
    }

    function addEmail() {
        const emailInput = $('#newEmailInput');
        const email = emailInput.val().trim();
        
        if (!email) {
            showAlert('warning', 'Please enter a valid email address.');
            return;
        }

        $.ajax({
            url: '/api/email',
            method: 'POST',
            headers: getAuthHeaders(),
            data: JSON.stringify({ email: email }),
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message);
                    emailInput.val(''); // Clear input
                    loadEmails(); // Reload email list
                } else {
                    showAlert('danger', response.message);
                }
            },
            error: function(xhr) {
                if (xhr.status === 401) {
                    showAlert('danger', 'Session expired. Please login again.');
                } else {
                    showAlert('danger', 'Failed to add email. Please try again.');
                }
            }
        });
    }

    // Global function for deleting emails
    window.deleteEmail = function(emailId) {
        if (!confirm('Are you sure you want to delete this email?')) {
            return;
        }

        $.ajax({
            url: `/api/email/${emailId}`,
            method: 'DELETE',
            headers: getAuthHeaders(),
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message);
                    loadEmails(); // Reload email list
                } else {
                    showAlert('danger', response.message);
                }
            },
            error: function(xhr) {
                if (xhr.status === 401) {
                    showAlert('danger', 'Session expired. Please login again.');
                } else {
                    showAlert('danger', 'Failed to delete email. Please try again.');
                }
            }
        });
    };

    // Global function for deleting all emails
    window.deleteAllEmails = function() {
        if (!confirm('Are you sure you want to delete ALL emails? This action cannot be undone.')) {
            return;
        }

        $.ajax({
            url: '/api/email/all',
            method: 'DELETE',
            headers: getAuthHeaders(),
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message);
                    loadEmails(); // Reload email list
                } else {
                    showAlert('danger', response.message);
                }
            },
            error: function(xhr) {
                if (xhr.status === 401) {
                    showAlert('danger', 'Session expired. Please login again.');
                } else {
                    showAlert('danger', 'Failed to delete all emails. Please try again.');
                }
            }
        });
    };

    // Global logout function
    window.logout = function() {
        localStorage.removeItem('jwt_token');
        window.location.href = '/api/user/login-page';
    };

    function showAlert(type, message) {
        const alert = $('.alert').last();
        alert.removeClass('alert-success alert-danger alert-warning alert-info')
             .addClass(`alert-${type}`)
             .text(message)
             .show();
        
        // Auto-hide success/info messages after 3 seconds
        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                alert.fadeOut();
            }, 3000);
        }
    }
});
</script>
{% endblock %}
